# Code Simplifier
#
# Nightly DRY enforcer. Finds duplication, dead code, and simplification opportunities.
# Creates focused draft PRs.
#
# This is a reusable workflow that can be called from other repositories.

name: Code Simplifier

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: code-simplifier-${{ github.repository }}
  cancel-in-progress: false

jobs:
  simplify:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub MCP
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'MCPEOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server:sha-45e90ae"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          MCPEOF

      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'PROMPT_EOF'
          # Code Simplifier

          Nightly DRY enforcer. Finds duplication, dead code, and simplification opportunities.
          Creates focused draft PRs.

          You are a code simplification specialist. Your mission is to keep the codebase clean,
          DRY, and well-organized.

          ## Pre-check

          First, check if any human (non-bot) commits occurred in the last 24 hours.
          Filter out bot accounts (containing `[bot]`, `noreply`, `github-actions`). If no human
          commits remain, exit without making changes.

          ## Analysis

          Examine the files changed in recent commits. Look for these issues in priority order:

          ### 1. DRY Violations (Highest Priority)

          - Duplicate code blocks (3+ lines repeated in multiple locations)
          - Constants or configuration values defined in more than one place
          - Repeated instructions or documentation (should use hierarchy and links)
          - Functions that could be extracted from repeated patterns

          ### 2. Dead Code

          - Unused imports or dependencies
          - Commented-out code blocks
          - Unreachable code branches
          - Variables assigned but never read

          ### 3. Single Responsibility Violations

          - Files covering two or more unrelated concerns (should be split)
          - Functions doing more than one distinct thing

          ### 4. Naming Issues

          - Files or directories that don't clearly describe their contents
          - Inconsistent naming conventions within the same module

          ## Output

          Pick the single highest-impact improvement. Create one focused draft PR that:

          - Changes the minimum number of files needed
          - Has a clear title describing the improvement
          - Includes a body explaining what was found and why the change helps
          - Does not introduce new functionality or change behavior
          PROMPT_EOF

      - name: Execute Claude Code
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-5-20250929
          prompt_file: /tmp/aw-prompts/prompt.txt
          mcp_config_file: /tmp/mcp-config/mcp-servers.json
          allowed_tools: Glob,Grep,LS,NotebookRead,Read,Task,mcp__github__create_pull_request,mcp__github__download_workflow_run_artifact,mcp__github__get_code_scanning_alert,mcp__github__get_commit,mcp__github__get_dependabot_alert,mcp__github__get_discussion,mcp__github__get_discussion_comments,mcp__github__get_file_contents,mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__get_job_logs,mcp__github__get_me,mcp__github__get_notification_details,mcp__github__get_pull_request,mcp__github__get_pull_request_comments,mcp__github__get_pull_request_diff,mcp__github__get_pull_request_files,mcp__github__get_pull_request_reviews,mcp__github__get_pull_request_status,mcp__github__get_secret_scanning_alert,mcp__github__get_tag,mcp__github__get_workflow_run,mcp__github__get_workflow_run_logs,mcp__github__get_workflow_run_usage,mcp__github__list_branches,mcp__github__list_code_scanning_alerts,mcp__github__list_commits,mcp__github__list_dependabot_alerts,mcp__github__list_discussion_categories,mcp__github__list_discussions,mcp__github__list_issues,mcp__github__list_notifications,mcp__github__list_pull_requests,mcp__github__list_secret_scanning_alerts,mcp__github__list_tags,mcp__github__list_workflow_jobs,mcp__github__list_workflow_run_artifacts,mcp__github__list_workflow_runs,mcp__github__list_workflows,mcp__github__search_code,mcp__github__search_issues,mcp__github__search_orgs,mcp__github__search_pull_requests,mcp__github__search_repositories,mcp__github__search_users
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
