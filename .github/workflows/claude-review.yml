# Claude Code Review
#
# Reusable workflow: automatic PR review with inline comments + interactive mode.
# Posts inline resolvable comments via mcp__github_inline_comment.
#
# Skip review by adding label: 'ai:skip-review'
# Summon manually: @claude in a PR conversation comment

name: Claude Code Review

on:
  workflow_call:
    inputs:
      review_prompt:
        description: "Optional repo-specific review focus"
        type: string
        default: ""
  workflow_dispatch:

# Workflow-level permissions set the maximum for all jobs.
# permissions: {} silently skips all jobs in cross-repo calls.
permissions:
  actions: read
  contents: read
  id-token: write
  issues: write
  pull-requests: write

concurrency:
  group: claude-review-${{ github.repository }}-${{ github.event.pull_request.number || github.event.issue.number || github.ref }}
  cancel-in-progress: true

jobs:
  review:
    name: Claude Code Review
    if: >-
      github.event.sender.type != 'Bot' &&
      github.event.pull_request != null &&
      !contains(github.event.pull_request.labels.*.name, 'ai:skip-review')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Checkout ai-workflows prompts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/scripts
            .github/prompts
          path: .ai-workflows

      - name: Render prompt
        id: prompt
        env:
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REVIEW_PROMPT: ${{ inputs.review_prompt }}
        run: bash .ai-workflows/.github/scripts/render-prompt.sh .ai-workflows/.github/prompts/claude-review.md

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"

  interactive:
    name: Claude Interactive
    if: >-
      github.event.comment != null &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Claude Interactive
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr review:*),Bash(gh issue comment:*)"
