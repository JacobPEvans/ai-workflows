# This file was automatically generated by gh-aw. DO NOT EDIT.
# To update this file, edit the corresponding .md file and run:
#   gh aw compile
# Note: anthropic_api_key patched to CLAUDE_CODE_OAUTH_TOKEN (gh-aw defaults to ANTHROPIC_API_KEY)

name: "Best Practices Recommender"
on:
    schedule:
        - cron: 0 3 * * 3
    workflow_dispatch: null

permissions: {}

concurrency:
  group: "gh-aw-${{ github.workflow }}"

run-name: "Best Practices Recommender"

jobs:
  task:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
          fetch-depth: 1

  check-recent-activity:
    name: Check for recent human activity
    needs: task
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
      - name: Check for human commits since last recommendation
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const run = require('./.github/scripts/best-practices/check-recent-activity.js');
            await run({ github, context, core });

  best-practices:
    name: Audit and recommend
    needs: [task, check-recent-activity]
    if: needs.check-recent-activity.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
        contents: read
        issues: write
        pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup MCPs
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:sha-45e90ae"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF
      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'EOF'
          # Best Practices Recommender

          Weekly audit of repository practices. Creates a single issue with 3-5 actionable recommendations.

          You are a best practices auditor. Your job is to review this repository and suggest
          improvements across CI/CD, security, documentation, code organization, and dependency
          management.

          ## Pre-check

          A pre-check job has already verified that human commits exist since the last
          best-practices issue. If you are running, the repository has had recent activity.

          ## Audit Areas

          Analyze the repository across these five dimensions:

          1. **CI/CD Patterns**: Are workflows efficient? Are there redundant steps, missing
             caching, or overly broad triggers? Are action versions pinned appropriately?

          2. **Security Practices**: Are secrets handled correctly? Are there hardcoded values
             that should be variables? Are permissions scoped minimally?

          3. **Documentation Standards**: Are README files current? Do complex functions have
             explanatory comments? Are configuration files documented?

          4. **Code Organization**: Is the directory structure logical? Are there orphaned files?
             Is naming consistent?

          5. **Dependency Management**: Are dependencies up to date? Are there unused
             dependencies? Is there a lock file?

          ## Output

          Create a single issue with:
          - Title: `chore: best practices recommendations — <YYYY-MM-DD>`
          - Body containing exactly 3-5 recommendations, each with:
            - **Area**: Which audit dimension
            - **Finding**: What was observed
            - **Recommendation**: Specific action to take
            - **Impact**: Low / Medium / High
          - Apply the `type:chore` label

          ## Rules

          - Maximum 5 recommendations per run
          - Focus on actionable items, not style preferences
          - Do not duplicate recommendations from open best-practices issues
          - Check existing open issues with "best practices recommendations" in the title
            before creating a new one — skip if one from the last 14 days exists
          - Never create PRs, only issues
          EOF
      - name: Print prompt to step summary
        run: |
          echo "## Generated Prompt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '``````markdown' >> $GITHUB_STEP_SUMMARY
          cat /tmp/aw-prompts/prompt.txt >> $GITHUB_STEP_SUMMARY
          echo '``````' >> $GITHUB_STEP_SUMMARY
      - name: Generate agentic run info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const awInfo = {
              engine_id: "claude",
              engine_name: "Claude Code",
              model: "claude-sonnet-4-5-20250929",
              version: "",
              workflow_name: "Best Practices Recommender",
              experimental: false,
              supports_tools_whitelist: true,
              supports_http_transport: true,
              run_id: context.runId,
              run_number: context.runNumber,
              run_attempt: process.env.GITHUB_RUN_ATTEMPT,
              repository: context.repo.owner + '/' + context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              actor: context.actor,
              event_name: context.eventName,
              created_at: new Date().toISOString()
            };

            const tmpPath = '/tmp/aw_info.json';
            fs.writeFileSync(tmpPath, JSON.stringify(awInfo, null, 2));
            console.log('Generated aw_info.json at:', tmpPath);
            console.log(JSON.stringify(awInfo, null, 2));
      - name: Execute Claude Code Action
        id: agentic_execution
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          # Allowed tools (sorted):
          # - Glob
          # - Grep
          # - LS
          # - NotebookRead
          # - Read
          # - Task
          # - mcp__github__add_issue_comment
          # - mcp__github__create_issue
          # - mcp__github__get_file_contents
          # - mcp__github__get_issue
          # - mcp__github__list_commits
          # - mcp__github__list_issues
          # - mcp__github__search_code
          allowed_tools: "Glob,Grep,LS,NotebookRead,Read,Task,mcp__github__add_issue_comment,mcp__github__create_issue,mcp__github__get_file_contents,mcp__github__get_issue,mcp__github__list_commits,mcp__github__list_issues,mcp__github__search_code"
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          model: claude-sonnet-4-5-20250929
          mcp_config: /tmp/mcp-config/mcp-servers.json
          prompt_file: /tmp/aw-prompts/prompt.txt
          timeout_minutes: "5"
      - name: Capture Agentic Action logs
        if: always()
        run: |
          if [ -n "${{ steps.agentic_execution.outputs.execution_file }}" ] && [ -f "${{ steps.agentic_execution.outputs.execution_file }}" ]; then
            cp ${{ steps.agentic_execution.outputs.execution_file }} /tmp/best-practices.log
          else
            echo "No execution file output found from Agentic Action" >> /tmp/best-practices.log
          fi
          touch /tmp/best-practices.log
      - name: Check if workflow-complete.txt exists, if so upload it
        id: check_file
        run: |
          if [ -f workflow-complete.txt ]; then
            echo "File exists"
            echo "upload=true" >> $GITHUB_OUTPUT
          else
            echo "File does not exist"
            echo "upload=false" >> $GITHUB_OUTPUT
          fi
      - name: Upload workflow-complete.txt
        if: steps.check_file.outputs.upload == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: workflow-complete
          path: workflow-complete.txt
      - name: Upload agentic engine logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: best-practices.log
          path: /tmp/best-practices.log
          if-no-files-found: warn
      - name: Upload agentic run info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aw_info.json
          path: /tmp/aw_info.json
          if-no-files-found: warn
