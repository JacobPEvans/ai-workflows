# This file was automatically generated by gh-aw. DO NOT EDIT.
# To update this file, edit the corresponding .md file and run:
#   gh aw compile

name: "Post-Merge Docs Review"
on:
    push:
        branches: [main]

permissions: {}

concurrency:
  group: "gh-aw-${{ github.workflow }}"

run-name: "Post-Merge Docs Review"

jobs:
  task:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
          fetch-depth: 1

  check-relevance:
    name: Check doc relevance
    needs: task
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is_relevant: ${{ steps.check.outputs.is_relevant }}
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
      - name: Check if changes are doc-relevant
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const run = require('./.github/scripts/post-merge-docs-review/check-docs-relevance.js');
            await run({ github, context, core });

  docs-review:
    name: Review documentation
    needs: [task, check-relevance]
    if: needs.check-relevance.outputs.is_relevant == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup MCPs
        env:
          GH_TOKEN_VALUE: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << EOF
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:sha-45e90ae"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${GH_TOKEN_VALUE}"
                }
              }
            }
          }
          EOF
      - name: Create prompt
        env:
          COMMIT_SHA: ${{ github.sha }}
          REPO_NAME: ${{ github.repository }}
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << PROMPT_EOF
          # Post-Merge Docs Review

          Reviews documentation for issues introduced by recent changes. Only creates PRs when issues exceed the decision threshold.

          You are a documentation quality analyst. Your job is to check if recently merged changes introduced documentation problems.

          ## Merge Context

          - **Commit**: ${COMMIT_SHA}
          - **Repository**: ${REPO_NAME}

          ## Pre-check

          1. List files changed in the merge commit.
          2. Identify which documentation files were changed or which code changes should have triggered doc updates.
          3. If no documentation-relevant changes exist, exit without action.

          ## Analysis

          Check for these issue categories in priority order:

          ### Critical (any one triggers a PR)
          - **Sensitive data exposure**: API keys, tokens, real IP addresses, internal hostnames, passwords, or PII in documentation files. Check against scrubbing rules: use 192.168.0.* for IPs, example.com/example.local for domains, your-token-here for secrets.
          - **Broken functionality**: Code examples that reference deleted functions, renamed files, or changed APIs.

          ### Non-critical (2+ needed to trigger a PR)
          - **DRY violations**: The same information repeated in multiple docs files.
          - **Code/doc inconsistency**: README describes behavior that no longer matches the code.
          - **Outdated references**: Links to moved/deleted files, references to old branch names, deprecated tool versions.
          - **Missing documentation**: New public APIs, CLI flags, or configuration options added without corresponding docs.

          ## Decision Threshold

          Create a PR ONLY if:
          - 1 or more critical issues found, OR
          - 2 or more non-critical issues found

          If below threshold, exit without action. Never create PRs for style-only changes.

          ## Output

          If threshold is met:

          1. Create a new branch from main with name docs/fix-<short-description>
          2. Fix the identified issues directly in the documentation files
          3. Create a draft PR with:
             - Title: docs: fix <brief description of issues>
             - Body listing each issue found, its category (critical/non-critical), and what was fixed
             - Include a "Detection Trigger" section explaining which merge prompted this review

          ## Rules

          - Never rewrite documentation style — only fix factual errors and policy violations
          - Preserve the original author's voice and formatting choices
          - If unsure whether something is an issue, skip it
          - Maximum 1 PR per run
          - Draft PRs only — never open ready-for-review PRs
          - Do not create PRs that only fix formatting or style
          PROMPT_EOF
      - name: Print prompt to step summary
        run: |
          echo "## Generated Prompt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '``````markdown' >> $GITHUB_STEP_SUMMARY
          cat /tmp/aw-prompts/prompt.txt >> $GITHUB_STEP_SUMMARY
          echo '``````' >> $GITHUB_STEP_SUMMARY
      - name: Generate agentic run info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const awInfo = {
              engine_id: "claude",
              engine_name: "Claude Code",
              model: "claude-sonnet-4-5-20250929",
              version: "",
              workflow_name: "Post-Merge Docs Review",
              experimental: false,
              supports_tools_whitelist: true,
              supports_http_transport: true,
              run_id: context.runId,
              run_number: context.runNumber,
              run_attempt: process.env.GITHUB_RUN_ATTEMPT,
              repository: context.repo.owner + '/' + context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              actor: context.actor,
              event_name: context.eventName,
              created_at: new Date().toISOString()
            };

            const tmpPath = '/tmp/aw_info.json';
            fs.writeFileSync(tmpPath, JSON.stringify(awInfo, null, 2));
            console.log('Generated aw_info.json at:', tmpPath);
            console.log(JSON.stringify(awInfo, null, 2));
      - name: Execute Claude Code Action
        id: agentic_execution
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          allowed_tools: "Bash(git:*),Edit,MultiEdit,Write,Read,Glob,Grep,LS,NotebookRead,Task,mcp__github__list_commits,mcp__github__get_commit,mcp__github__get_file_contents,mcp__github__search_code,mcp__github__create_pull_request,mcp__github__list_pull_requests"
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          model: claude-sonnet-4-5-20250929
          mcp_config: /tmp/mcp-config/mcp-servers.json
          prompt_file: /tmp/aw-prompts/prompt.txt
          timeout_minutes: "10"
      - name: Capture Agentic Action logs
        if: always()
        env:
          EXECUTION_FILE: ${{ steps.agentic_execution.outputs.execution_file }}
        run: |
          if [ -n "$EXECUTION_FILE" ] && [ -f "$EXECUTION_FILE" ]; then
            cp "$EXECUTION_FILE" /tmp/post-merge-docs-review.log
          else
            echo "No execution file output found from Agentic Action" >> /tmp/post-merge-docs-review.log
          fi
          touch /tmp/post-merge-docs-review.log
      - name: Upload agentic engine logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: post-merge-docs-review.log
          path: /tmp/post-merge-docs-review.log
          if-no-files-found: warn
      - name: Upload agentic run info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aw_info.json
          path: /tmp/aw_info.json
          if-no-files-found: warn
