# This file was automatically generated by gh-aw. DO NOT EDIT.
# To update this file, edit the corresponding .md file and run:
#   gh aw compile

name: "Final PR Review"
on:
    pull_request_review:
        types: [submitted]
    check_suite:
        types: [completed]

permissions: {}

concurrency:
  group: "gh-aw-final-pr-review-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number }}"

run-name: "Final PR Review"

jobs:
  gate-check:
    name: Check review gate
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: read
      checks: read
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      pr_number: ${{ steps.gate.outputs.pr_number }}
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
      - name: Check gate conditions
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const run = require('./.github/scripts/final-pr-review/check-gate.js');
            await run({ github, context, core });

  review:
    name: Claude Final Review
    needs: gate-check
    if: needs.gate-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      checks: read
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup MCPs
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'EOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": [
                  "run",
                  "-i",
                  "--rm",
                  "-e",
                  "GITHUB_PERSONAL_ACCESS_TOKEN",
                  "ghcr.io/github/github-mcp-server:sha-45e90ae"
                ],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          EOF
      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'PROMPT_EOF'
          # Final PR Review

          Last-eyes review before merge. Triggers when a PR becomes mergeable (all CI passes + human review exists).

          You are a senior code reviewer performing a final architectural review. This review runs automatically when a PR meets all merge criteria.

          ## Pre-check

          This workflow is gated by a JavaScript check in `.github/scripts/final-pr-review/check-gate.js`. If you are running, the gate has already passed: the PR is open, not a draft, has human reviews, all checks pass, and has not been Claude-reviewed yet.

          ## Review Context

          - **PR Number**: ${{ needs.gate-check.outputs.pr_number }}
          - **Repository**: ${{ github.repository }}

          ## Review Scope

          Focus on what human reviewers naturally miss in file-by-file reviews:

          1. **Cross-cutting concerns**: Do changes in one file break assumptions in another? Are imports, types, and interfaces consistent across the changeset?
          2. **Architectural coherence**: Do the changes follow the repository's established patterns? Any accidental coupling or abstraction violations?
          3. **Reviewer feedback addressed**: Did the PR author actually address the feedback from human reviewers, or just acknowledge it?
          4. **Merge readiness**: Are there any TODO/FIXME/HACK comments that should be resolved before merge? Any debugging artifacts left behind?
          5. **Risk assessment**: What could go wrong after merge? Any edge cases that tests don't cover?

          ## Review Format

          Use GitHub's review API. If you find issues:
          - COMMENT for observations and suggestions
          - REQUEST_CHANGES only for genuine merge-blocking problems (security issues, data loss risks, broken functionality)

          If the PR looks good, APPROVE with a brief summary of what you verified.

          ## Rules

          - Never approve your own changes (bot-authored PRs)
          - Never rubber-stamp — if you can't find anything meaningful to say, note what you verified
          - Keep comments actionable and specific (file + line reference)
          - Do not repeat feedback already given by human reviewers
          - Maximum 5 review comments — focus on highest-impact findings
          PROMPT_EOF
      - name: Print prompt to step summary
        run: |
          echo "## Generated Prompt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '``````markdown' >> $GITHUB_STEP_SUMMARY
          cat /tmp/aw-prompts/prompt.txt >> $GITHUB_STEP_SUMMARY
          echo '``````' >> $GITHUB_STEP_SUMMARY
      - name: Generate agentic run info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const awInfo = {
              engine_id: "claude",
              engine_name: "Claude Code",
              model: "claude-sonnet-4-5-20250929",
              version: "",
              workflow_name: "Final PR Review",
              experimental: false,
              supports_tools_whitelist: true,
              supports_http_transport: true,
              run_id: context.runId,
              run_number: context.runNumber,
              run_attempt: process.env.GITHUB_RUN_ATTEMPT,
              repository: context.repo.owner + '/' + context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              actor: context.actor,
              event_name: context.eventName,
              created_at: new Date().toISOString()
            };

            const tmpPath = '/tmp/aw_info.json';
            fs.writeFileSync(tmpPath, JSON.stringify(awInfo, null, 2));
            console.log('Generated aw_info.json at:', tmpPath);
            console.log(JSON.stringify(awInfo, null, 2));
      - name: Execute Claude Code Action
        id: agentic_execution
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          allowed_tools: "Glob,Grep,LS,NotebookRead,Read,Task,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__get_pull_request_files,mcp__github__get_pull_request_reviews,mcp__github__get_pull_request_comments,mcp__github__get_pull_request_status,mcp__github__list_pull_requests,mcp__github__get_file_contents,mcp__github__search_code,mcp__github__get_issue,mcp__github__list_issue_comments,mcp__github__create_or_update_pull_request_review"
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          model: claude-sonnet-4-5-20250929
          mcp_config: /tmp/mcp-config/mcp-servers.json
          prompt_file: /tmp/aw-prompts/prompt.txt
          timeout_minutes: "10"
      - name: Capture Agentic Action logs
        if: always()
        run: |
          if [ -n "${{ steps.agentic_execution.outputs.execution_file }}" ] && [ -f "${{ steps.agentic_execution.outputs.execution_file }}" ]; then
            cp ${{ steps.agentic_execution.outputs.execution_file }} /tmp/final-pr-review.log
          else
            echo "No execution file output found from Agentic Action" >> /tmp/final-pr-review.log
          fi
          touch /tmp/final-pr-review.log
      - name: Upload agentic engine logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-pr-review.log
          path: /tmp/final-pr-review.log
          if-no-files-found: warn
      - name: Upload agentic run info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aw_info.json
          path: /tmp/aw_info.json
          if-no-files-found: warn

  add-label:
    name: Mark as reviewed
    needs: [gate-check, review]
    if: needs.gate-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
      - name: Add claude-reviewed label
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ needs.gate-check.outputs.pr_number }}
        with:
          script: |
            const run = require('./.github/scripts/final-pr-review/add-label.js');
            await run({ github, context, core });
