# Post-Merge Tests
#
# Reusable workflow: analyzes merged code and creates draft PRs with targeted tests.
# Gated by a pre-check for test infrastructure.
#
# Security: Uses github.sha and github.repository (both safe, immutable system values)
# passed via env vars to prevent any shell injection risks.

name: Post-Merge Tests

on:
  workflow_call:
  workflow_dispatch:

permissions: {}

concurrency:
  group: post-merge-tests-${{ github.repository }}

jobs:
  check-test-infra:
    name: Check test infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_tests: ${{ steps.check.outputs.has_tests }}
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v4
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Check for test infrastructure
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/post-merge-tests/check-test-infra.js');
            await run({ github, context, core });

  post-merge-tests:
    name: Analyze and create tests
    needs: check-test-infra
    if: needs.check-test-infra.outputs.has_tests == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub MCP
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'MCPEOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server:sha-45e90ae"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          MCPEOF

      - name: Create prompt
        env:
          # Security: github.sha and github.repository are safe system values
          MERGE_SHA: ${{ github.sha }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << PROMPT_EOF
          # Post-Merge Test Coverage

          Analyzes newly merged code and creates draft PRs with targeted tests for uncovered functionality.

          You are a test coverage analyst. Your job is to identify merged code that lacks test coverage and create targeted tests following the repository's existing patterns.

          ## Merge Context

          - **Commit**: ${MERGE_SHA}
          - **Repository**: ${REPO_FULL_NAME}

          ## Pre-check

          1. List files changed in the merge commit.
          2. If the changed files are only documentation, CI configuration, or other non-testable files, exit without action.

          ## Analysis

          For each changed file that has testable logic:

          1. Check if corresponding test files already exist (e.g., \`src/foo.js\` → \`tests/foo.test.js\`)
          2. If tests exist, check if they cover the newly changed/added functionality
          3. Identify functions, methods, or logic paths that lack test coverage

          ## Output

          If you find uncovered testable code:

          1. Create a new branch from \`main\` with name \`chore/add-tests-<short-description>\`
          2. Write 1-2 targeted test files following the EXACT patterns found in existing tests:
             - Same test framework and assertion style
             - Same file naming convention
             - Same directory structure
             - Same import patterns and test utilities
          3. Create a draft PR with:
             - Title: \`test: add coverage for <what was merged>\`
             - Body explaining: what merge triggered this, what's being tested, what existing patterns were followed

          ## Rules

          - Maximum 2 test files per run
          - Follow existing test patterns exactly — never introduce new test libraries or frameworks
          - Only test public APIs and exported functions
          - Do not create tests for trivial getters/setters or configuration files
          - If existing test coverage is already comprehensive, exit without action
          - Draft PRs only — never open ready-for-review PRs
          PROMPT_EOF

      - name: Run Claude
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          allowed_tools: "Bash(git:*),Edit,MultiEdit,Write,Read,Glob,Grep,LS,NotebookRead,Task,mcp__github__list_commits,mcp__github__get_commit,mcp__github__get_file_contents,mcp__github__search_code,mcp__github__create_pull_request,mcp__github__list_pull_requests"
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          model: claude-sonnet-4-5-20250929
          mcp_config: /tmp/mcp-config/mcp-servers.json
          prompt_file: /tmp/aw-prompts/prompt.txt
          timeout_minutes: "10"
