# Post-Merge Tests
#
# Reusable workflow: analyzes merged code and creates draft PRs with targeted tests.
# Gated by a pre-check for test infrastructure.
#
# Security: Uses github.sha and github.repository (both safe, immutable system values)
# passed via env vars to prevent any shell injection risks.

name: Post-Merge Tests

on:
  workflow_call:
  workflow_dispatch:

permissions: {}

concurrency:
  group: post-merge-tests-${{ github.repository }}

jobs:
  check-test-infra:
    name: Check test infrastructure
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_tests: ${{ steps.check.outputs.has_tests }}
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v4
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Check for test infrastructure
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/post-merge-tests/check-test-infra.js');
            await run({ github, context, core });

  post-merge-tests:
    name: Analyze and create tests
    needs: check-test-infra
    if: needs.check-test-infra.outputs.has_tests == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout ai-workflows
        uses: actions/checkout@v4
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/prompts
            .github/configs
          path: .ai-workflows

      - name: Setup GitHub MCP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p /tmp/mcp-config
          envsubst < .ai-workflows/.github/configs/mcp-github.json.template > /tmp/mcp-config/mcp-servers.json

      - name: Render prompt
        env:
          MERGE_SHA: ${{ github.sha }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: envsubst < .ai-workflows/.github/prompts/post-merge-tests.md > /tmp/prompt.md

      - name: Run Claude
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          allowed_tools: "Bash(git:*),Edit,MultiEdit,Write,Read,Glob,Grep,LS,NotebookRead,Task,mcp__github__list_commits,mcp__github__get_commit,mcp__github__get_file_contents,mcp__github__search_code,mcp__github__create_pull_request,mcp__github__list_pull_requests"
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          model: claude-sonnet-4-5-20250929
          mcp_config: /tmp/mcp-config/mcp-servers.json
          prompt_file: /tmp/prompt.md
          timeout_minutes: "10"
