# Post-Merge Docs Review
#
# Reusable workflow: reviews documentation after merges for issues.
# Gated by a pre-check for doc-relevant changes.
#
# Security: Uses github.sha and github.repository (both safe, immutable system values)
# passed via env vars to prevent any shell injection risks.

name: Post-Merge Docs Review

on:
  workflow_call:
  workflow_dispatch:

# Workflow-level permissions set the maximum for all jobs.
# permissions: {} silently skips all jobs in cross-repo calls.
permissions:
  contents: write
  id-token: write
  pull-requests: write

concurrency:
  group: post-merge-docs-${{ github.repository }}

jobs:
  check-relevance:
    name: Check doc relevance
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is_relevant: ${{ steps.check.outputs.is_relevant }}
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Check if changes are doc-relevant
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/post-merge-docs-review/check-docs-relevance.js');
            await run({ github, context, core });

  post-merge-docs-review:
    name: Review and fix docs
    needs: check-relevance
    if: needs.check-relevance.outputs.is_relevant == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout ai-workflows
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/prompts
            .github/scripts
          path: .ai-workflows

      - name: Render prompt
        id: prompt
        env:
          COMMIT_SHA: ${{ github.sha }}
          REPO_NAME: ${{ github.repository }}
        run: bash .ai-workflows/.github/scripts/render-prompt.sh .ai-workflows/.github/prompts/post-merge-docs-review.md COMMIT_SHA REPO_NAME

      - name: Run Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ssh_signing_key: ${{ secrets.GH_CLAUDE_SSH_SIGNING_KEY }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: >-
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh pr:*),Bash(gh api:*),Bash(gh search:*)"
            --model claude-sonnet-4-6
