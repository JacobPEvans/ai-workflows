# Final PR Review
#
# Reusable workflow: last-eyes Claude review when PR becomes mergeable.
# Triggers when all checks pass and a human review exists.
# Adds ai:reviewed label to prevent re-triggering.

name: Final PR Review

on:
  workflow_call:
  workflow_dispatch:

# Workflow-level permissions set the maximum for all jobs.
# permissions: {} silently skips all jobs in cross-repo calls.
permissions:
  checks: read
  contents: read
  id-token: write
  issues: write
  pull-requests: write

concurrency:
  group: final-pr-review-${{ github.repository }}-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

jobs:
  gate-check:
    name: Check review gate
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: read
      checks: read
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      pr_number: ${{ steps.gate.outputs.pr_number }}
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Check gate conditions
        id: gate
        uses: actions/github-script@v8
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/final-pr-review/check-gate.js');
            await run({ github, context, core });

  review:
    name: Claude Final Review
    needs: gate-check
    if: needs.gate-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      checks: read
      contents: read
      id-token: write
      issues: read
      pull-requests: write
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout ai-workflows prompts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/scripts
            .github/prompts
          path: .ai-workflows

      - name: Render prompt
        id: prompt
        env:
          PR_NUMBER: ${{ needs.gate-check.outputs.pr_number }}
        run: bash .ai-workflows/.github/scripts/render-prompt.sh .ai-workflows/.github/prompts/final-pr-review.md

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: >-
            --model claude-sonnet-4-6
            --allowedTools "Read,Glob,Grep,LS,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr review:*)"

  add-label:
    name: Mark as reviewed
    needs: [gate-check, review]
    if: needs.gate-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Add ai:reviewed label
        uses: actions/github-script@v8
        env:
          PR_NUMBER: ${{ needs.gate-check.outputs.pr_number }}
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/final-pr-review/add-label.js');
            await run({ github, context, core });
