# Issue Sweeper
#
# Weekly scan of open issues. Comments on progress, closes resolved issues with PR links.
#
# This is a reusable workflow that can be called from other repositories.

name: Issue Sweeper

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: issue-sweeper-${{ github.repository }}
  cancel-in-progress: false

jobs:
  sweep:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub MCP
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'MCPEOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server:sha-45e90ae"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          MCPEOF

      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'PROMPT_EOF'
          # Issue Sweeper

          Weekly scan of open issues. Comments on progress, closes resolved issues with PR links.

          You are an issue completeness analyst. Your job is to review every open issue in this
          repository and determine its current status.

          ## Process

          For each open issue:

          1. **Check for linked PRs**: Search for pull requests that reference this issue number
             (`#<number>` in title, body, or commits). Check if any are merged.

          2. **Check for branches**: Look for branches named after the issue
             (e.g., `feat/issue-42`, `fix/42-description`).

          3. **Check recent commits**: Search commit messages from the last 30 days for references
             to this issue number.

          4. **Classify the issue**:

             - **Resolved**: A merged PR references this issue. Close the issue with a comment
               linking the PR(s) that resolved it. Use format:
               `Resolved by #<pr-number>. Closing automatically.`

             - **In Progress**: An open PR or active branch exists. Comment with current status:
               `In progress: PR #<number> is open (or branch <name> exists).`
               Do not comment if you already commented with the same status previously.

             - **Stale**: No linked PRs, no branches, no commit references, and no activity in
               30+ days. Comment:
               `This issue has had no activity for 30+ days. Is this still relevant?`
               Do not comment if a stale comment was already posted.

          ## Rules

          - Never close an issue unless a merged PR directly references it.
          - Never duplicate comments. Check existing comments before posting.
          - Process issues in order of oldest first.
          PROMPT_EOF

      - name: Execute Claude Code
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-5-20250929
          prompt_file: /tmp/aw-prompts/prompt.txt
          mcp_config: /tmp/mcp-config/mcp-servers.json
          allowed_tools: Glob,Grep,LS,NotebookRead,Read,Task,mcp__github__add_issue_comment,mcp__github__download_workflow_run_artifact,mcp__github__get_code_scanning_alert,mcp__github__get_commit,mcp__github__get_dependabot_alert,mcp__github__get_discussion,mcp__github__get_discussion_comments,mcp__github__get_file_contents,mcp__github__get_issue,mcp__github__get_issue_comments,mcp__github__get_job_logs,mcp__github__get_me,mcp__github__get_notification_details,mcp__github__get_pull_request,mcp__github__get_pull_request_comments,mcp__github__get_pull_request_diff,mcp__github__get_pull_request_files,mcp__github__get_pull_request_reviews,mcp__github__get_pull_request_status,mcp__github__get_secret_scanning_alert,mcp__github__get_tag,mcp__github__get_workflow_run,mcp__github__get_workflow_run_logs,mcp__github__get_workflow_run_usage,mcp__github__list_branches,mcp__github__list_code_scanning_alerts,mcp__github__list_commits,mcp__github__list_dependabot_alerts,mcp__github__list_discussion_categories,mcp__github__list_discussions,mcp__github__list_issue_comments,mcp__github__list_issues,mcp__github__list_notifications,mcp__github__list_pull_requests,mcp__github__list_secret_scanning_alerts,mcp__github__list_tags,mcp__github__list_workflow_jobs,mcp__github__list_workflow_run_artifacts,mcp__github__list_workflow_runs,mcp__github__list_workflows,mcp__github__search_code,mcp__github__search_issues,mcp__github__search_orgs,mcp__github__search_pull_requests,mcp__github__search_repositories,mcp__github__search_users,mcp__github__update_issue
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
