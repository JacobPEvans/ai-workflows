# Issue Auto-Resolver (Claude)
#
# Reusable workflow: called by consumer repos after issue-triage.yml.
# Runs eligibility gates, then uses Claude to create a draft PR fixing the issue.
# Claude handles its own issue comments (start marker, PR link, abort notice).

name: Issue Resolver (Claude)

on:
  workflow_call:
    inputs:
      repo_context:
        description: "Brief description of the repository for Claude's context"
        type: string
        required: true
      extra_tools:
        description: "Additional allowed tools beyond defaults (e.g., Bash(tofu:*))"
        type: string
        default: ""
      model:
        description: "Claude model to use"
        type: string
        default: "sonnet"
      excluded_labels:
        description: "Comma-separated labels that block auto-resolution"
        type: string
        default: "type:security,type:feature,type:breaking,size:l,size:xl"
      max_attempts:
        description: "Max resolution attempts per issue"
        type: string
        default: "1"
      issue_number:
        description: "Issue number to resolve (overrides event payload; enables manual dispatch)"
        type: string
        default: "0"
      allowed_authors:
        description: "Comma-separated author_association values allowed to trigger resolution"
        type: string
        default: "OWNER,MEMBER,COLLABORATOR,CONTRIBUTOR"

# Workflow-level permissions set the maximum for all jobs.
# permissions: {} silently skips all jobs in cross-repo calls.
permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

concurrency:
  group: issue-resolver-${{ github.repository }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  eligibility-check:
    name: Check eligibility
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_title: ${{ steps.check.outputs.issue_title }}
      issue_body: ${{ steps.check.outputs.issue_body }}
      issue_labels: ${{ steps.check.outputs.issue_labels }}
      attempt: ${{ steps.check.outputs.attempt }}
      max_attempts: ${{ inputs.max_attempts }}
    steps:
      - name: Checkout ai-workflows scripts
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: .github/scripts
          path: .ai-workflows

      - name: Check eligibility
        id: check
        env:
          EXCLUDED_LABELS: ${{ inputs.excluded_labels }}
          MAX_ATTEMPTS: ${{ inputs.max_attempts }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ALLOWED_AUTHORS: ${{ inputs.allowed_authors }}
        uses: actions/github-script@v8
        with:
          script: |
            const run = require('./.ai-workflows/.github/scripts/issue-resolver/check-eligibility.js');
            await run({ github, context, core });

  resolve:
    name: Claude Resolve
    needs: eligibility-check
    if: needs.eligibility-check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout ai-workflows
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/scripts
            .github/prompts
          path: .ai-workflows

      - name: Render prompt
        id: prompt
        env:
          REPO_CONTEXT: ${{ inputs.repo_context }}
          ISSUE_NUMBER: ${{ needs.eligibility-check.outputs.issue_number }}
          ISSUE_TITLE: ${{ needs.eligibility-check.outputs.issue_title }}
          ISSUE_BODY: ${{ needs.eligibility-check.outputs.issue_body }}
          ISSUE_LABELS: ${{ needs.eligibility-check.outputs.issue_labels }}
          ATTEMPT: ${{ needs.eligibility-check.outputs.attempt }}
          MAX_ATTEMPTS: ${{ needs.eligibility-check.outputs.max_attempts }}
        run: bash .ai-workflows/.github/scripts/render-prompt.sh .ai-workflows/.github/prompts/issue-resolver.md REPO_CONTEXT ISSUE_NUMBER ISSUE_TITLE ISSUE_BODY ISSUE_LABELS ATTEMPT MAX_ATTEMPTS

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ssh_signing_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          bot_name: "jacobpevans-github-actions[bot]"
          bot_id: "251056911"
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: >-
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(gh pr create:*),Bash(gh issue comment:*)${{ inputs.extra_tools != '' && format(',{0}', inputs.extra_tools) || '' }}"
            ${{ inputs.model != '' && format('--model {0}', inputs.model) || '' }}
