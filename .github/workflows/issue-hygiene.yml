# Issue Hygiene
#
# Companion to Issue Sweeper. Detects duplicates, links merged PRs, flags wontfix
# candidates, and suggests issue combinations.
#
# This is a reusable workflow that can be called from other repositories.

name: Issue Hygiene

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

concurrency:
  group: issue-hygiene-${{ github.repository }}
  cancel-in-progress: false

jobs:
  hygiene:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub MCP
        run: |
          mkdir -p /tmp/mcp-config
          cat > /tmp/mcp-config/mcp-servers.json << 'MCPEOF'
          {
            "mcpServers": {
              "github": {
                "command": "docker",
                "args": ["run", "-i", "--rm", "-e", "GITHUB_PERSONAL_ACCESS_TOKEN", "ghcr.io/github/github-mcp-server:sha-45e90ae"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              }
            }
          }
          MCPEOF

      - name: Create prompt
        run: |
          mkdir -p /tmp/aw-prompts
          cat > /tmp/aw-prompts/prompt.txt << 'PROMPT_EOF'
          # Issue Hygiene

          Companion to Issue Sweeper. Detects duplicates, links merged PRs, flags wontfix
          candidates, and suggests issue combinations.

          You are an issue hygiene analyst. Issue Sweeper (which runs 1 hour before you) handles
          resolved/in-progress/stale classification. Your job is the complementary analysis:
          duplicates, cross-references, and housekeeping suggestions.

          ## Process

          Retrieve all open issues (up to 50, oldest first). For each issue:

          ### 1. Duplicate Detection

          Compare each issue's title and body against all other open issues. Flag likely
          duplicates when:
          - Titles share 3+ significant words (excluding common words like "add", "fix", "the")
          - Bodies describe the same problem or feature request

          If duplicates are found, comment on the newer issue:
          `Possible duplicate of #<older-issue>. These issues appear to describe the same work.
          Consider closing one in favor of the other.`

          ### 2. Merged PR Linking

          Search for merged pull requests that reference the issue number in their title or body
          but did not auto-close the issue (missing `Closes #N` / `Fixes #N` keywords).

          If found, comment:
          `PR #<number> (<title>) was merged and references this issue but did not auto-close it.
          If this issue is resolved, it can be closed manually.`

          ### 3. Wontfix Candidates

          Flag issues that show signals of being abandoned or out of scope:
          - Issue is 90+ days old with no linked PRs or branches
          - Original author has not commented in 60+ days
          - Issue description conflicts with recent project direction (based on recent merges)

          If flagged, comment:
          `This issue has been open for <N> days with no linked work. Consider whether this is
          still in scope, or if it should be closed as wontfix.`

          ### 4. Combination Suggestions

          Identify issues that could be combined into a single effort:
          - Issues in the same area (similar file paths or components mentioned)
          - Issues that form a natural sequence (e.g., "add X" and "add tests for X")

          If found, comment on both issues:
          `This issue and #<other> could potentially be addressed together as a single effort.`

          ## Rules

          - Never close issues — only comment with suggestions
          - Never apply labels — only suggest via comments
          - Do not duplicate comments. Check existing comments before posting.
          - Process at most 50 issues per run
          - Skip issues that already have hygiene comments from a previous run
          PROMPT_EOF

      - name: Execute Claude Code
        uses: anthropics/claude-code-base-action@v0.0.56
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: claude-sonnet-4-5-20250929
          prompt_file: /tmp/aw-prompts/prompt.txt
          mcp_config_file: /tmp/mcp-config/mcp-servers.json
          allowed_tools: Glob,Grep,LS,NotebookRead,Read,Task,mcp__github__add_issue_comment,mcp__github__get_issue,mcp__github__get_pull_request,mcp__github__list_issue_comments,mcp__github__list_issues,mcp__github__list_pull_requests,mcp__github__search_issues
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
