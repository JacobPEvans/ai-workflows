# Issue Hygiene
#
# Companion to Issue Sweeper. Detects duplicates, links merged PRs, flags wontfix
# candidates, and suggests issue combinations.
#
# This is a reusable workflow that can be called from other repositories.

name: Issue Hygiene

on:
  workflow_call:
  workflow_dispatch:

# Workflow-level permissions set the maximum for all jobs.
# permissions: {} silently skips all jobs in cross-repo calls.
permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: read

concurrency:
  group: issue-hygiene-${{ github.repository }}
  cancel-in-progress: false

jobs:
  hygiene:
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: read
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout ai-workflows
        uses: actions/checkout@v6
        with:
          repository: JacobPEvans/ai-workflows
          sparse-checkout: |
            .github/prompts
            .github/scripts
          path: .ai-workflows

      - name: Render prompt
        id: prompt
        run: bash .ai-workflows/.github/scripts/render-prompt.sh .ai-workflows/.github/prompts/issue-hygiene.md

      - name: Execute Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: >-
            --allowedTools "Read,Glob,Grep,LS,Bash(gh issue:*),Bash(gh pr:*),Bash(gh search:*)"
            --model claude-sonnet-4-6
